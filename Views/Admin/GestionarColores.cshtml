@model Asgard_Store.Models.Producto

@{
    ViewData["Title"] = "Gestionar Colores - " + Model.Nombre;
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="~/css/styles.css">
    <link rel="stylesheet" href="~/css/admin.css">
    <style>
        .color-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .color-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .color-preview {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #e2e8f0;
        }

        .variantes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .variante-card {
            background: #f7fafc;
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
        }

            .variante-card:hover {
                border-color: #667eea;
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            }

        .variante-imagen {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 2px solid #e2e8f0;
        }

        .sin-imagen-placeholder {
            width: 100%;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #edf2f7;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 2px dashed #cbd5e0;
            color: #a0aec0;
            font-size: 2rem;
        }

        .variante-nombre {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .btn-icon {
            padding: 8px 12px;
            font-size: 0.85rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 5px;
        }

        .btn-upload {
            background: #667eea;
            color: white;
        }

            .btn-upload:hover {
                background: #5568d3;
            }

        .btn-delete-img {
            background: #fc8181;
            color: white;
        }

            .btn-delete-img:hover {
                background: #f56565;
            }

        .btn-delete-variant {
            background: #e53e3e;
            color: white;
        }

            .btn-delete-variant:hover {
                background: #c53030;
            }

        .nueva-variante-form {
            background: #e6f3ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            border: 2px dashed #667eea;
        }

        .form-inline {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .form-group-inline {
            flex: 1;
            min-width: 200px;
        }

        .imagen-upload-mini {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

            .imagen-upload-mini:hover {
                border-color: #667eea;
                background: #f0f4ff;
            }

        .preview-mini {
            max-width: 150px;
            max-height: 150px;
            border-radius: 8px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1><a href="@Url.Action("Index", "Home")" style="color: white; text-decoration: none;">🧦 Asgard Store</a></h1>
            <nav>
                <a href="@Url.Action("Index", "Admin")">Panel Admin</a>
                <a href="@Url.Action("Productos", "Admin")">Volver a Productos</a>
            </nav>
        </div>
    </header>

    <div class="admin-container">
        <aside class="admin-sidebar">
            <h2>📊 Administración</h2>
            <ul>
                <li><a href="@Url.Action("Index", "Admin")">Inicio</a></li>
                <li><a href="@Url.Action("Productos", "Admin")" class="active">Productos</a></li>
                <li><a href="@Url.Action("Categorias", "Admin")">Categorías</a></li>
                <li><a href="@Url.Action("Pedidos", "Admin")">Pedidos</a></li>
                <li><a href="@Url.Action("Usuarios", "Admin")">Usuarios</a></li>
            </ul>
        </aside>

        <main class="admin-content">
            <h1>🎨 Gestionar Colores y Variantes: @Model.Nombre</h1>

            @if (TempData["Success"] != null)
            {
                <div class="alert alert-success">@TempData["Success"]</div>
            }
            @if (TempData["Error"] != null)
            {
                <div class="alert alert-error">@TempData["Error"]</div>
            }

            <!-- Formulario para Agregar Nuevo Color Base -->
            <div class="color-card">
                <h2>➕ Agregar Nuevo Color Base</h2>
                <form asp-action="AgregarColorBase" asp-route-productoId="@Model.ProductoID" method="post">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Nombre del Color *</label>
                            <input type="text" name="nombreColor" required placeholder="Ej: Negro, Azul, Rojo" class="form-control">
                        </div>

                        <div class="form-group">
                            <label>Código Hexadecimal (Opcional)</label>
                            <input type="text" name="codigoHex" placeholder="#000000" maxlength="7" class="form-control">
                        </div>
                    </div>
                    <button type="submit" class="btn-primary">💾 Crear Color Base</button>
                    <small style="color: #718096; display: block; margin-top: 10px;">
                        Después de crear el color base, podrás agregar variantes individuales con sus imágenes.
                    </small>
                </form>
            </div>

            <!-- Lista de Colores Existentes con sus Variantes -->
            <h2 style="margin-top: 40px;">📋 Colores y Variantes</h2>

            @if (Model.Colores != null && Model.Colores.Any())
            {
                @foreach (var color in Model.Colores)
                {
                    <div class="color-card">
                        <div class="color-header">
                            @if (!string.IsNullOrEmpty(color.CodigoHex))
                            {
                                <div class="color-preview" style="background: @color.CodigoHex;"></div>
                            }
                            else
                            {
                                <div class="color-preview" style="background: #e2e8f0;"></div>
                            }

                            <div style="flex: 1;">
                                <h3 style="margin: 0;">@color.NombreColor</h3>
                                @if (!string.IsNullOrEmpty(color.CodigoHex))
                                {
                                    <small style="color: #718096; font-family: monospace;">@color.CodigoHex</small>
                                }
                            </div>

                            <form asp-action="EliminarColor" asp-route-id="@color.ColorID" method="post" style="display: inline;"
                                  onsubmit="return confirm('¿Eliminar este color y TODAS sus variantes?');">
                                <button type="submit" class="btn-danger">🗑️ Eliminar Color</button>
                            </form>
                        </div>

                        <hr style="margin: 20px 0; border: none; border-top: 1px solid #e2e8f0;">

                        <h4 style="color: #2d3748; margin-bottom: 15px;">Variantes de @color.NombreColor</h4>

                        @if (color.VariantesColeccion != null && color.VariantesColeccion.Any())
                        {
                            <div class="variantes-grid">
                                @foreach (var variante in color.VariantesColeccion.OrderBy(v => v.Orden))
                                {
                                    <div class="variante-card">
                                        @if (!string.IsNullOrEmpty(variante.ImagenUrl))
                                        {
                                            <img src="@variante.ImagenUrl" alt="@variante.NombreVariante" class="variante-imagen">
                                        }
                                        else
                                        {
                                            <div class="sin-imagen-placeholder">
                                                🖼️
                                            </div>
                                        }

                                        <div class="variante-nombre">@variante.NombreVariante</div>

                                        <div style="margin: 10px 0;">
                                            <strong>Stock:</strong>
                                            @if (variante.Stock <= 0)
                                            {
                                                <span style="background: #fed7d7; color: #742a2a; padding: 3px 10px; border-radius: 12px; font-size: 0.85rem;">
                                                    ❌ @variante.Stock unidades
                                                </span>
                                            }
                                            else if (variante.Stock <= 10)
                                            {
                                                <span style="background: #feebc8; color: #7c2d12; padding: 3px 10px; border-radius: 12px; font-size: 0.85rem;">
                                                    ⚠️ @variante.Stock unidades
                                                </span>
                                            }
                                            else
                                            {
                                                <span style="background: #c6f6d5; color: #22543d; padding: 3px 10px; border-radius: 12px; font-size: 0.85rem;">
                                                    ✓ @variante.Stock unidades
                                                </span>
                                            }

                                            <button type="button"
                                                    class="btn-icon btn-upload"
                                                    onclick="editarStock(@variante.VarianteID, '@variante.NombreVariante', @variante.Stock)">
                                                📦 Stock
                                            </button>
                                        </div>

                                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                            <!-- Botón para subir/cambiar imagen -->
                                            <button type="button" class="btn-icon btn-upload" onclick="document.getElementById('file-@variante.VarianteID').click()">
                                                📸 @(string.IsNullOrEmpty(variante.ImagenUrl) ? "Subir" : "Cambiar")
                                            </button>

                                            <form asp-action="SubirImagenVariante" method="post" enctype="multipart/form-data"
                                                  id="form-img-@variante.VarianteID" style="display: none;">
                                                <input type="hidden" name="varianteId" value="@variante.VarianteID" />
                                                <input type="file"
                                                       id="file-@variante.VarianteID"
                                                       name="imagenFile"
                                                       accept="image/*"
                                                       onchange="this.form.submit()">
                                            </form>

                                            @if (!string.IsNullOrEmpty(variante.ImagenUrl))
                                            {
                                                <form asp-action="EliminarImagenVariante" asp-route-id="@variante.VarianteID" method="post" style="display: inline;">
                                                    <button type="submit" class="btn-icon btn-delete-img" onclick="return confirm('¿Eliminar imagen?')">
                                                        🗑️ Imagen
                                                    </button>
                                                </form>
                                            }

                                            <form asp-action="EliminarVariante" asp-route-id="@variante.VarianteID" method="post" style="display: inline;">
                                                <button type="submit" class="btn-icon btn-delete-variant" onclick="return confirm('¿Eliminar variante?')">
                                                    ✕ Variante
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p style="color: #718096; font-style: italic;">No hay variantes para este color</p>
                        }

                        <!-- Formulario para agregar nueva variante -->
                        <div class="nueva-variante-form">
                            <h4 style="margin-top: 0; color: #2d3748;">➕ Agregar Nueva Variante</h4>
                            <form asp-action="AgregarVariante" asp-route-colorId="@color.ColorID" method="post" enctype="multipart/form-data">
                                <div class="form-inline">
                                    <div class="form-group-inline">
                                        <label>Nombre de la Variante *</label>
                                        <input type="text" name="nombreVariante" required placeholder="Ej: Tipo 1, Modelo A" class="form-control">
                                    </div>

                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label>Stock *</label>
                                        <input type="number" name="stock" value="0" min="0" required class="form-control">
                                    </div>

                                    <div class="form-group-inline">
                                        <label>Imagen (Opcional)</label>
                                        <div class="imagen-upload-mini" onclick="document.getElementById('nueva-img-@color.ColorID').click()">
                                            <div>📸 Click para imagen</div>
                                            <input type="file"
                                                   id="nueva-img-@color.ColorID"
                                                   name="imagenFile"
                                                   accept="image/*"
                                                   style="display: none;"
                                                   onchange="previewImage(this, 'preview-@color.ColorID')">
                                        </div>
                                        <img id="preview-@color.ColorID" style="display: none;" class="preview-mini">
                                    </div>

                                    <div style="display: flex; align-items: flex-end;">
                                        <button type="submit" class="btn-primary">💾 Agregar Variante</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                }
            }
            else
            {
                <div style="text-align: center; padding: 40px; background: white; border-radius: 12px;">
                    <p style="color: #718096;">No hay colores agregados. Crea un color base primero.</p>
                </div>
            }

            <div style="margin-top: 30px;">
                <a href="@Url.Action("Productos", "Admin")" class="btn-primary">← Volver a Productos</a>
            </div>
        </main>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2026 Asgard Store. Administración.</p>
        </div>
    </footer>

    <script>
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);

            if (input.files && input.files[0]) {
                const reader = new FileReader();

                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };

                reader.readAsDataURL(input.files[0]);
            }
        }
    </script>

    <script>
        function editarStock(varianteId, nombre, stockActual) {
            const nuevoStock = prompt(`Stock actual de "${nombre}": ${stockActual} unidades\n\nIngresa el nuevo stock:`, stockActual);

            if (nuevoStock !== null) {
                const stock = parseInt(nuevoStock);

                if (isNaN(stock) || stock < 0) {
                    alert('Por favor ingresa un número válido mayor o igual a 0');
                    return;
                }

                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/Admin/ActualizarStockVariante';

                const inputVariante = document.createElement('input');
                inputVariante.type = 'hidden';
                inputVariante.name = 'varianteId';
                inputVariante.value = varianteId;

                const inputStock = document.createElement('input');
                inputStock.type = 'hidden';
                inputStock.name = 'nuevoStock';
                inputStock.value = stock;

                const token = document.querySelector('input[name="__RequestVerificationToken"]');
                if (token) {
                    form.appendChild(token.cloneNode());
                }

                form.appendChild(inputVariante);
                form.appendChild(inputStock);
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>

</body>
</html>
